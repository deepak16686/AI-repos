<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1500 2100">
  <defs>
    <!-- Gradients -->
    <linearGradient id="userGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#4fc3f7;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#0288d1;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="frontendGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#81c784;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#388e3c;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="backendGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#ffb74d;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#f57c00;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="aiGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#ce93d8;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#7b1fa2;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="gitlabGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#fc6d26;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#e24329;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="securityGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#ef5350;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#c62828;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="successGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#66bb6a;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#2e7d32;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="failureGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#ff7043;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#d84315;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="storageGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#4dd0e1;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#00838f;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="configGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#fff176;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#f9a825;stop-opacity:1" />
    </linearGradient>
    
    <!-- Filters -->
    <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
      <feDropShadow dx="3" dy="3" stdDeviation="4" flood-opacity="0.25"/>
    </filter>
    <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
      <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
      <feMerge>
        <feMergeNode in="coloredBlur"/>
        <feMergeNode in="SourceGraphic"/>
      </feMerge>
    </filter>
    
    <!-- Arrow Markers -->
    <marker id="arrowBlue" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#1976d2"/>
    </marker>
    <marker id="arrowOrange" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#f57c00"/>
    </marker>
    <marker id="arrowPurple" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#7b1fa2"/>
    </marker>
    <marker id="arrowGreen" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#388e3c"/>
    </marker>
    <marker id="arrowRed" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#c62828"/>
    </marker>
    <marker id="arrowGitlab" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#e24329"/>
    </marker>
    <marker id="arrowCyan" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#00838f"/>
    </marker>
    <marker id="arrowYellow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#f9a825"/>
    </marker>
  </defs>
  
  <!-- Background -->
  <rect width="1500" height="2100" fill="#fafafa"/>
  
  <!-- Title Section -->
  <rect x="0" y="0" width="1500" height="80" fill="#1a237e"/>
  <text x="750" y="35" font-family="Segoe UI, Arial, sans-serif" font-size="28" font-weight="bold" fill="white" text-anchor="middle">AI-Powered CI/CD Pipeline Generation Flow</text>
  <text x="750" y="60" font-family="Segoe UI, Arial, sans-serif" font-size="14" fill="#b3e5fc" text-anchor="middle">Auto-Detection â€¢ RAG-Enhanced LLM â€¢ Automatic Failure Learning â€¢ Continuous Improvement</text>

  <!-- ==================== PHASE 1: REQUEST INTAKE (Improved) ==================== -->
  <rect x="20" y="100" width="1460" height="280" rx="12" fill="#e3f2fd" stroke="#1976d2" stroke-width="2" filter="url(#shadow)"/>
  <text x="40" y="130" font-family="Segoe UI, Arial, sans-serif" font-size="18" font-weight="bold" fill="#1565c0">PHASE 1: Request Intake &amp; UI Configuration</text>
  
  <!-- User Actor -->
  <g transform="translate(50, 160)">
    <circle cx="50" cy="30" r="28" fill="url(#userGrad)" filter="url(#shadow)"/>
    <text x="50" y="35" font-family="Segoe UI, Arial, sans-serif" font-size="22" fill="white" text-anchor="middle">ğŸ‘¤</text>
    <text x="50" y="80" font-family="Segoe UI, Arial, sans-serif" font-size="12" font-weight="600" fill="#0277bd" text-anchor="middle">DevOps Admin</text>
  </g>
  
  <!-- User Input Box - UPDATED -->
  <rect x="150" y="150" width="260" height="140" rx="8" fill="white" stroke="#42a5f5" stroke-width="2" filter="url(#shadow)"/>
  <text x="280" y="175" font-family="Segoe UI, Arial, sans-serif" font-size="13" font-weight="600" fill="#1565c0" text-anchor="middle">User Provides Only:</text>
  <text x="165" y="200" font-family="Consolas, monospace" font-size="11" fill="#2e7d32">âœ“ Repo URL (GitLab)</text>
  <text x="165" y="220" font-family="Consolas, monospace" font-size="11" fill="#2e7d32">âœ“ Target Registry (Nexus repo)</text>
  <text x="165" y="240" font-family="Consolas, monospace" font-size="11" fill="#2e7d32">âœ“ Environment (dev/qa/prod)</text>
  <text x="165" y="265" font-family="Consolas, monospace" font-size="11" fill="#c62828">âœ— Language (auto-detected)</text>
  <text x="165" y="282" font-family="Consolas, monospace" font-size="11" fill="#c62828">âœ— Build tool (auto-detected)</text>
  
  <!-- Arrow to Frontend -->
  <path d="M410 220 L450 220" stroke="#1976d2" stroke-width="3" fill="none" marker-end="url(#arrowBlue)"/>
  <text x="430" y="210" font-family="Segoe UI, Arial, sans-serif" font-size="10" fill="#1565c0" text-anchor="middle">1</text>
  
  <!-- Open WebUI Frontend - EXPANDED with Model/Tools Config -->
  <rect x="460" y="145" width="480" height="220" rx="8" fill="url(#frontendGrad)" filter="url(#shadow)"/>
  <text x="700" y="172" font-family="Segoe UI, Arial, sans-serif" font-size="16" font-weight="bold" fill="white" text-anchor="middle">ğŸŒ Open WebUI - Frontend Portal</text>
  
  <!-- Chat Interface -->
  <rect x="475" y="185" width="220" height="85" rx="4" fill="rgba(255,255,255,0.95)"/>
  <text x="585" y="205" font-family="Segoe UI, Arial, sans-serif" font-size="11" font-weight="600" fill="#2e7d32" text-anchor="middle">ğŸ’¬ Chat Interface</text>
  <text x="485" y="225" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#37474f">â€¢ Natural language prompts</text>
  <text x="485" y="240" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#37474f">â€¢ Repo URL input field</text>
  <text x="485" y="255" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#37474f">â€¢ Target registry selector</text>
  <text x="485" y="268" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#37474f">â€¢ File preview &amp; diff view</text>
  
  <!-- Model &amp; Tools Config Panel -->
  <rect x="705" y="185" width="220" height="85" rx="4" fill="rgba(255,255,255,0.95)"/>
  <text x="815" y="205" font-family="Segoe UI, Arial, sans-serif" font-size="11" font-weight="600" fill="#2e7d32" text-anchor="middle">âš™ï¸ Model &amp; Tools Config</text>
  <text x="715" y="225" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#37474f">â€¢ Select LLM model (Ollama)</text>
  <text x="715" y="240" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#37474f">â€¢ Enable/disable tools</text>
  <text x="715" y="255" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#37474f">â€¢ System prompt templates</text>
  <text x="715" y="268" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#37474f">â€¢ RAG settings &amp; context</text>
  
  <!-- Prompt Templates -->
  <rect x="475" y="280" width="220" height="75" rx="4" fill="rgba(255,255,255,0.95)"/>
  <text x="585" y="298" font-family="Segoe UI, Arial, sans-serif" font-size="11" font-weight="600" fill="#2e7d32" text-anchor="middle">ğŸ“ Prompt Templates</text>
  <text x="485" y="315" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#37474f">â€¢ Dockerfile generation prompt</text>
  <text x="485" y="330" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#37474f">â€¢ GitLab CI generation prompt</text>
  <text x="485" y="345" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#37474f">â€¢ Custom user prompts</text>
  
  <!-- Tool Functions -->
  <rect x="705" y="280" width="220" height="75" rx="4" fill="rgba(255,255,255,0.95)"/>
  <text x="815" y="298" font-family="Segoe UI, Arial, sans-serif" font-size="11" font-weight="600" fill="#2e7d32" text-anchor="middle">ğŸ”§ MCP Tool Functions</text>
  <text x="715" y="315" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#37474f">â€¢ gitlab_inspect_repo()</text>
  <text x="715" y="330" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#37474f">â€¢ nexus_check_registry()</text>
  <text x="715" y="345" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#37474f">â€¢ sonar_scan(), fortify_scan()</text>
  
  <!-- Configuration Storage -->
  <rect x="960" y="145" width="260" height="220" rx="8" fill="url(#configGrad)" filter="url(#shadow)"/>
  <text x="1090" y="172" font-family="Segoe UI, Arial, sans-serif" font-size="14" font-weight="bold" fill="#5d4037" text-anchor="middle">ğŸ’¾ Config Storage</text>
  <text x="1090" y="192" font-family="Segoe UI, Arial, sans-serif" font-size="10" fill="#795548" text-anchor="middle">(Where configs are saved)</text>
  
  <rect x="975" y="205" width="230" height="150" rx="4" fill="rgba(255,255,255,0.95)"/>
  <text x="1090" y="225" font-family="Segoe UI, Arial, sans-serif" font-size="10" font-weight="600" fill="#e65100" text-anchor="middle">PostgreSQL (ai-postgres:5432)</text>
  <text x="985" y="248" font-family="Consolas, monospace" font-size="9" fill="#37474f">ğŸ“ prompt_templates</text>
  <text x="1000" y="263" font-family="Consolas, monospace" font-size="8" fill="#64748b">- system_prompts, user_prompts</text>
  <text x="985" y="283" font-family="Consolas, monospace" font-size="9" fill="#37474f">ğŸ“ model_configs</text>
  <text x="1000" y="298" font-family="Consolas, monospace" font-size="8" fill="#64748b">- model_name, temperature, tools</text>
  <text x="985" y="318" font-family="Consolas, monospace" font-size="9" fill="#37474f">ğŸ“ user_preferences</text>
  <text x="1000" y="333" font-family="Consolas, monospace" font-size="8" fill="#64748b">- default_registry, env settings</text>
  <text x="985" y="348" font-family="Consolas, monospace" font-size="9" fill="#37474f">ğŸ“ chat_history</text>
  
  <!-- Arrow from UI to Storage -->
  <path d="M940 280 L960 280" stroke="#f9a825" stroke-width="2" fill="none" marker-end="url(#arrowYellow)"/>
  <text x="950" y="270" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#f57f17">Save</text>
  
  <!-- Arrow to Backend -->
  <path d="M1220 280 L1280 280" stroke="#f9a825" stroke-width="2" fill="none" marker-end="url(#arrowOrange)"/>
  <text x="1250" y="270" font-family="Segoe UI, Arial, sans-serif" font-size="10" fill="#e65100" text-anchor="middle">2</text>
  
  <!-- Request Payload -->
  <rect x="1240" y="145" width="220" height="220" rx="8" fill="white" stroke="#ff9800" stroke-width="2" filter="url(#shadow)"/>
  <text x="1350" y="168" font-family="Segoe UI, Arial, sans-serif" font-size="12" font-weight="600" fill="#e65100" text-anchor="middle">ğŸ“¤ Request Payload</text>
  <rect x="1250" y="178" width="200" height="175" rx="4" fill="#fff3e0"/>
  <text x="1260" y="198" font-family="Consolas, monospace" font-size="10" fill="#37474f">{</text>
  <text x="1270" y="215" font-family="Consolas, monospace" font-size="9" fill="#37474f">"repo_url": "gitlab/...",</text>
  <text x="1270" y="232" font-family="Consolas, monospace" font-size="9" fill="#2e7d32">"target_registry": "nexus",</text>
  <text x="1270" y="249" font-family="Consolas, monospace" font-size="9" fill="#37474f">"environment": "dev",</text>
  <text x="1270" y="266" font-family="Consolas, monospace" font-size="9" fill="#37474f">"model_config": {...},</text>
  <text x="1270" y="283" font-family="Consolas, monospace" font-size="9" fill="#37474f">"prompt_template_id": "...",</text>
  <text x="1270" y="300" font-family="Consolas, monospace" font-size="9" fill="#37474f">"tools_enabled": [...],</text>
  <text x="1270" y="317" font-family="Consolas, monospace" font-size="9" fill="#37474f">"request_id": "uuid",</text>
  <text x="1270" y="334" font-family="Consolas, monospace" font-size="9" fill="#37474f">"user_id": "..."</text>
  <text x="1260" y="348" font-family="Consolas, monospace" font-size="10" fill="#37474f">}</text>

  <!-- ==================== PHASE 2: AUTO-DETECTION & GENERATION ==================== -->
  <rect x="20" y="400" width="1460" height="400" rx="12" fill="#fff3e0" stroke="#ff9800" stroke-width="2" filter="url(#shadow)"/>
  <text x="40" y="430" font-family="Segoe UI, Arial, sans-serif" font-size="18" font-weight="bold" fill="#e65100">PHASE 2: Automatic Detection &amp; AI Generation</text>
  
  <!-- Backend Orchestrator -->
  <rect x="50" y="455" width="280" height="180" rx="12" fill="url(#backendGrad)" filter="url(#shadow)"/>
  <text x="190" y="485" font-family="Segoe UI, Arial, sans-serif" font-size="15" font-weight="bold" fill="white" text-anchor="middle">âš™ï¸ Backend Orchestrator</text>
  <rect x="65" y="500" width="250" height="125" rx="6" fill="rgba(255,255,255,0.95)"/>
  <text x="190" y="520" font-family="Segoe UI, Arial, sans-serif" font-size="10" fill="#e65100" text-anchor="middle" font-weight="600">Core Functions:</text>
  <text x="75" y="540" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#37474f">â€¢ Load model config &amp; prompts from DB</text>
  <text x="75" y="555" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#37474f">â€¢ Initialize enabled MCP tools</text>
  <text x="75" y="570" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#37474f">â€¢ AuthN/AuthZ &amp; secrets management</text>
  <text x="75" y="585" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#37474f">â€¢ Request routing &amp; state mgmt</text>
  <text x="75" y="600" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#37474f">â€¢ Correlation IDs &amp; audit logs</text>
  <text x="75" y="615" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#37474f">â€¢ Trigger auto-learning on failures</text>
  
  <!-- Arrow down from Phase 1 -->
  <path d="M1350 365 L1350 395 L190 395 L190 455" stroke="#f57c00" stroke-width="3" fill="none" marker-end="url(#arrowOrange)"/>
  <text x="770" y="388" font-family="Segoe UI, Arial, sans-serif" font-size="10" fill="#e65100">3. Process Request</text>
  
  <!-- GitLab Auto-Detection - IMPROVED -->
  <rect x="370" y="455" width="320" height="180" rx="8" fill="url(#gitlabGrad)" filter="url(#shadow)"/>
  <text x="530" y="483" font-family="Segoe UI, Arial, sans-serif" font-size="15" font-weight="bold" fill="white" text-anchor="middle">ğŸ¦Š GitLab API - AUTO-DETECTION</text>
  <rect x="385" y="498" width="290" height="127" rx="4" fill="rgba(255,255,255,0.95)"/>
  <text x="530" y="518" font-family="Segoe UI, Arial, sans-serif" font-size="11" fill="#c62828" text-anchor="middle" font-weight="600">ğŸ” Automatic Code Analysis:</text>
  <text x="395" y="540" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#37474f">âœ“ Detect languages (Java/Python/Node/Go/.NET)</text>
  <text x="395" y="557" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#37474f">âœ“ Identify package manager (maven/gradle/npm/pip)</text>
  <text x="395" y="574" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#37474f">âœ“ Find lockfiles (pom.xml, package.json, etc.)</text>
  <text x="395" y="591" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#37474f">âœ“ Check existing Dockerfile/CI config</text>
  <text x="395" y="608" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#37474f">âœ“ Detect build outputs (jar/war/dist/wheel)</text>
  <text x="395" y="622" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#37474f">âœ“ Identify special requirements (private deps)</text>
  
  <!-- Arrow Backend to GitLab -->
  <path d="M330 545 L370 545" stroke="#e24329" stroke-width="2" fill="none" marker-end="url(#arrowGitlab)"/>
  <text x="350" y="535" font-family="Segoe UI, Arial, sans-serif" font-size="10" fill="#e24329" text-anchor="middle">4</text>
  
  <!-- Detected Context Output -->
  <rect x="370" y="645" width="320" height="80" rx="6" fill="white" stroke="#e24329" stroke-width="2"/>
  <text x="530" y="668" font-family="Segoe UI, Arial, sans-serif" font-size="11" font-weight="600" fill="#e24329" text-anchor="middle">ğŸ“‹ Auto-Detected Context</text>
  <text x="380" y="688" font-family="Consolas, monospace" font-size="9" fill="#37474f">{"lang": "java", "build": "maven", "jdk": "17",</text>
  <text x="380" y="703" font-family="Consolas, monospace" font-size="9" fill="#37474f"> "type": "spring-boot", "has_docker": false}</text>
  <text x="380" y="718" font-family="Consolas, monospace" font-size="9" fill="#64748b">// No user input needed for tech detection!</text>
  
  <!-- AI/RAG Stack -->
  <rect x="730" y="455" width="360" height="330" rx="12" fill="url(#aiGrad)" filter="url(#shadow)"/>
  <text x="910" y="483" font-family="Segoe UI, Arial, sans-serif" font-size="15" font-weight="bold" fill="white" text-anchor="middle">ğŸ¤– AI Generation Stack</text>
  
  <!-- Ollama LLM -->
  <rect x="745" y="498" width="160" height="80" rx="6" fill="rgba(255,255,255,0.95)"/>
  <text x="825" y="520" font-family="Segoe UI, Arial, sans-serif" font-size="12" font-weight="600" fill="#7b1fa2" text-anchor="middle">Ollama LLM</text>
  <text x="825" y="538" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#37474f" text-anchor="middle">Code Generation Engine</text>
  <text x="825" y="555" font-family="Consolas, monospace" font-size="9" fill="#64748b" text-anchor="middle">:11434</text>
  <text x="825" y="572" font-family="Segoe UI, Arial, sans-serif" font-size="8" fill="#9e9e9e" text-anchor="middle">(Model from UI config)</text>
  
  <!-- ChromaDB RAG -->
  <rect x="915" y="498" width="160" height="80" rx="6" fill="rgba(255,255,255,0.95)"/>
  <text x="995" y="520" font-family="Segoe UI, Arial, sans-serif" font-size="12" font-weight="600" fill="#7b1fa2" text-anchor="middle">ChromaDB RAG</text>
  <text x="995" y="538" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#37474f" text-anchor="middle">Knowledge Retrieval</text>
  <text x="995" y="555" font-family="Consolas, monospace" font-size="9" fill="#64748b" text-anchor="middle">:8000</text>
  <text x="995" y="572" font-family="Segoe UI, Arial, sans-serif" font-size="8" fill="#9e9e9e" text-anchor="middle">(Templates + Fix Patterns)</text>
  
  <!-- RAG Knowledge Content -->
  <rect x="745" y="590" width="330" height="80" rx="4" fill="rgba(255,255,255,0.9)"/>
  <text x="910" y="610" font-family="Segoe UI, Arial, sans-serif" font-size="10" fill="#7b1fa2" text-anchor="middle" font-weight="600">ğŸ“š RAG Knowledge Base Contents:</text>
  <text x="755" y="630" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#37474f">â€¢ Approved base images per language (from Nexus)</text>
  <text x="755" y="645" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#37474f">â€¢ Standard GitLab CI templates (org standards)</text>
  <text x="755" y="660" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#2e7d32">â€¢ Auto-learned failure fix patterns âœ“</text>
  
  <!-- Prompt Processing -->
  <rect x="745" y="680" width="330" height="95" rx="4" fill="rgba(255,255,255,0.9)"/>
  <text x="910" y="700" font-family="Segoe UI, Arial, sans-serif" font-size="10" fill="#7b1fa2" text-anchor="middle" font-weight="600">ğŸ“ Prompt Assembly (from UI Config):</text>
  <text x="755" y="720" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#37474f">1. Load system prompt template from DB</text>
  <text x="755" y="735" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#37474f">2. Inject auto-detected repo context</text>
  <text x="755" y="750" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#37474f">3. Add retrieved RAG knowledge chunks</text>
  <text x="755" y="765" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#37474f">4. Apply user target registry constraint</text>
  
  <!-- Arrow GitLab to AI -->
  <path d="M690 685 L745 685" stroke="#7b1fa2" stroke-width="2" fill="none" marker-end="url(#arrowPurple)"/>
  <text x="718" y="675" font-family="Segoe UI, Arial, sans-serif" font-size="10" fill="#7b1fa2" text-anchor="middle">5</text>
  
  <!-- Generated Output -->
  <rect x="1110" y="455" width="350" height="330" rx="8" fill="white" stroke="#7b1fa2" stroke-width="2" filter="url(#shadow)"/>
  <text x="1285" y="480" font-family="Segoe UI, Arial, sans-serif" font-size="13" font-weight="600" fill="#7b1fa2" text-anchor="middle">ğŸ“„ Generated Output</text>
  
  <rect x="1125" y="495" width="320" height="135" rx="4" fill="#f3e5f5"/>
  <text x="1285" y="515" font-family="Segoe UI, Arial, sans-serif" font-size="10" font-weight="600" fill="#4a148c" text-anchor="middle">Files Generated:</text>
  <text x="1135" y="540" font-family="Consolas, monospace" font-size="10" fill="#4a148c">ğŸ“¦ Dockerfile</text>
  <text x="1145" y="555" font-family="Consolas, monospace" font-size="9" fill="#64748b">- Multi-stage build (auto-optimized)</text>
  <text x="1145" y="570" font-family="Consolas, monospace" font-size="9" fill="#64748b">- Base image from approved list</text>
  <text x="1135" y="590" font-family="Consolas, monospace" font-size="10" fill="#4a148c">ğŸ“‹ .gitlab-ci.yml</text>
  <text x="1145" y="605" font-family="Consolas, monospace" font-size="9" fill="#64748b">- All scan stages included</text>
  <text x="1145" y="620" font-family="Consolas, monospace" font-size="9" fill="#2e7d32">- Push to user-specified registry</text>
  
  <rect x="1125" y="640" width="320" height="80" rx="4" fill="#e8f5e9"/>
  <text x="1285" y="660" font-family="Segoe UI, Arial, sans-serif" font-size="10" font-weight="600" fill="#2e7d32" text-anchor="middle">Metadata &amp; Docs:</text>
  <text x="1135" y="680" font-family="Consolas, monospace" font-size="9" fill="#37474f">ğŸ“ CI variables required (masked)</text>
  <text x="1135" y="695" font-family="Consolas, monospace" font-size="9" fill="#37474f">ğŸ’¡ Assumptions &amp; rationale</text>
  <text x="1135" y="710" font-family="Consolas, monospace" font-size="9" fill="#37474f">ğŸ“– README-ci.md (usage guide)</text>
  
  <!-- Validation Box -->
  <rect x="1125" y="730" width="320" height="45" rx="4" fill="#fff3e0"/>
  <text x="1285" y="752" font-family="Segoe UI, Arial, sans-serif" font-size="10" font-weight="600" fill="#e65100" text-anchor="middle">ğŸ” Auto-Validation: YAML lint, Dockerfile checks</text>
  <text x="1285" y="768" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#37474f" text-anchor="middle">Self-correct with LLM on failures (bounded retries)</text>
  
  <!-- Arrow AI to Output -->
  <path d="M1090 600 L1110 600" stroke="#7b1fa2" stroke-width="2" fill="none" marker-end="url(#arrowPurple)"/>
  <text x="1100" y="590" font-family="Segoe UI, Arial, sans-serif" font-size="10" fill="#7b1fa2" text-anchor="middle">6</text>

  <!-- ==================== PHASE 3: USER REVIEW & COMMIT ==================== -->
  <rect x="20" y="820" width="1460" height="150" rx="12" fill="#e8f5e9" stroke="#4caf50" stroke-width="2" filter="url(#shadow)"/>
  <text x="40" y="850" font-family="Segoe UI, Arial, sans-serif" font-size="18" font-weight="bold" fill="#2e7d32">PHASE 3: User Review &amp; Commit to GitLab</text>
  
  <!-- Review UI -->
  <rect x="50" y="870" width="320" height="85" rx="8" fill="url(#frontendGrad)" filter="url(#shadow)"/>
  <text x="210" y="898" font-family="Segoe UI, Arial, sans-serif" font-size="13" font-weight="bold" fill="white" text-anchor="middle">ğŸ‘ï¸ User Review (Open WebUI)</text>
  <rect x="65" y="910" width="290" height="35" rx="4" fill="rgba(255,255,255,0.95)"/>
  <text x="210" y="932" font-family="Segoe UI, Arial, sans-serif" font-size="10" fill="#2e7d32" text-anchor="middle">View files â€¢ Check target registry â€¢ Edit if needed</text>
  
  <!-- Approve Button -->
  <rect x="400" y="885" width="120" height="50" rx="25" fill="url(#successGrad)" filter="url(#shadow)"/>
  <text x="460" y="915" font-family="Segoe UI, Arial, sans-serif" font-size="14" font-weight="bold" fill="white" text-anchor="middle">âœ“ Approve</text>
  
  <!-- Arrow to GitLab -->
  <path d="M520 910 L580 910" stroke="#2e7d32" stroke-width="3" fill="none" marker-end="url(#arrowGreen)"/>
  <text x="550" y="900" font-family="Segoe UI, Arial, sans-serif" font-size="10" fill="#2e7d32" text-anchor="middle">7</text>
  
  <!-- GitLab Commit -->
  <rect x="590" y="870" width="320" height="85" rx="8" fill="url(#gitlabGrad)" filter="url(#shadow)"/>
  <text x="750" y="898" font-family="Segoe UI, Arial, sans-serif" font-size="14" font-weight="bold" fill="white" text-anchor="middle">ğŸ¦Š GitLab Commit</text>
  <rect x="605" y="910" width="290" height="35" rx="4" fill="rgba(255,255,255,0.95)"/>
  <text x="750" y="932" font-family="Segoe UI, Arial, sans-serif" font-size="10" fill="#e65100" text-anchor="middle">Branch: ai/generated-ci/&lt;ts&gt; â†’ Merge Request</text>
  
  <!-- Arrow to Pipeline -->
  <path d="M910 910 L970 910" stroke="#e24329" stroke-width="3" fill="none" marker-end="url(#arrowGitlab)"/>
  <text x="940" y="900" font-family="Segoe UI, Arial, sans-serif" font-size="10" fill="#e24329" text-anchor="middle">8</text>
  
  <!-- Pipeline Trigger -->
  <rect x="980" y="870" width="220" height="85" rx="8" fill="white" stroke="#e24329" stroke-width="2" filter="url(#shadow)"/>
  <text x="1090" y="898" font-family="Segoe UI, Arial, sans-serif" font-size="13" font-weight="600" fill="#e24329" text-anchor="middle">ğŸš€ Pipeline Triggered</text>
  <text x="1090" y="920" font-family="Segoe UI, Arial, sans-serif" font-size="10" fill="#37474f" text-anchor="middle">Auto-trigger on commit</text>
  <text x="1090" y="938" font-family="Segoe UI, Arial, sans-serif" font-size="10" fill="#37474f" text-anchor="middle">Push to: user's target registry</text>
  
  <!-- Backend Observer -->
  <rect x="1220" y="870" width="240" height="85" rx="8" fill="url(#backendGrad)" filter="url(#shadow)"/>
  <text x="1340" y="898" font-family="Segoe UI, Arial, sans-serif" font-size="12" font-weight="bold" fill="white" text-anchor="middle">ğŸ‘ï¸ Backend Observer</text>
  <rect x="1235" y="910" width="210" height="35" rx="4" fill="rgba(255,255,255,0.95)"/>
  <text x="1340" y="932" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#e65100" text-anchor="middle">Webhooks/Polling â†’ Stage results, logs</text>

  <!-- ==================== PHASE 4: PIPELINE EXECUTION ==================== -->
  <rect x="20" y="990" width="1460" height="180" rx="12" fill="#fce4ec" stroke="#e91e63" stroke-width="2" filter="url(#shadow)"/>
  <text x="40" y="1020" font-family="Segoe UI, Arial, sans-serif" font-size="18" font-weight="bold" fill="#c2185b">PHASE 4: Pipeline Execution &amp; Security Scans</text>
  
  <!-- Pipeline Stages - Compact -->
  <g transform="translate(50, 1040)">
    <rect x="0" y="0" width="100" height="55" rx="5" fill="white" stroke="#1976d2" stroke-width="1.5"/>
    <text x="50" y="22" font-family="Segoe UI, Arial, sans-serif" font-size="10" font-weight="600" fill="#1565c0" text-anchor="middle">ğŸ”¨ Build</text>
    <text x="50" y="40" font-family="Segoe UI, Arial, sans-serif" font-size="8" fill="#37474f" text-anchor="middle">Compile/Package</text>
    
    <path d="M100 27 L115 27" stroke="#64748b" stroke-width="1.5" fill="none" marker-end="url(#arrowBlue)"/>
    
    <rect x="120" y="0" width="100" height="55" rx="5" fill="white" stroke="#1976d2" stroke-width="1.5"/>
    <text x="170" y="22" font-family="Segoe UI, Arial, sans-serif" font-size="10" font-weight="600" fill="#1565c0" text-anchor="middle">ğŸ§ª Test</text>
    <text x="170" y="40" font-family="Segoe UI, Arial, sans-serif" font-size="8" fill="#37474f" text-anchor="middle">Unit/Integration</text>
    
    <path d="M220 27 L235 27" stroke="#64748b" stroke-width="1.5" fill="none" marker-end="url(#arrowRed)"/>
    
    <rect x="240" y="0" width="100" height="55" rx="5" fill="white" stroke="#c62828" stroke-width="1.5"/>
    <text x="290" y="22" font-family="Segoe UI, Arial, sans-serif" font-size="10" font-weight="600" fill="#c62828" text-anchor="middle">ğŸ“Š Sonar</text>
    <text x="290" y="40" font-family="Segoe UI, Arial, sans-serif" font-size="8" fill="#37474f" text-anchor="middle">Code Quality</text>
    
    <path d="M340 27 L355 27" stroke="#c62828" stroke-width="1.5" fill="none" marker-end="url(#arrowRed)"/>
    
    <rect x="360" y="0" width="100" height="55" rx="5" fill="white" stroke="#c62828" stroke-width="1.5"/>
    <text x="410" y="22" font-family="Segoe UI, Arial, sans-serif" font-size="10" font-weight="600" fill="#c62828" text-anchor="middle">ğŸ” Sonatype</text>
    <text x="410" y="40" font-family="Segoe UI, Arial, sans-serif" font-size="8" fill="#37474f" text-anchor="middle">SCA/Policy</text>
    
    <path d="M460 27 L475 27" stroke="#c62828" stroke-width="1.5" fill="none" marker-end="url(#arrowRed)"/>
    
    <rect x="480" y="0" width="100" height="55" rx="5" fill="white" stroke="#c62828" stroke-width="1.5"/>
    <text x="530" y="22" font-family="Segoe UI, Arial, sans-serif" font-size="10" font-weight="600" fill="#c62828" text-anchor="middle">ğŸ›¡ï¸ Fortify</text>
    <text x="530" y="40" font-family="Segoe UI, Arial, sans-serif" font-size="8" fill="#37474f" text-anchor="middle">SAST/DAST</text>
    
    <path d="M580 27 L595 27" stroke="#0288d1" stroke-width="1.5" fill="none" marker-end="url(#arrowBlue)"/>
    
    <rect x="600" y="0" width="100" height="55" rx="5" fill="white" stroke="#0288d1" stroke-width="1.5"/>
    <text x="650" y="22" font-family="Segoe UI, Arial, sans-serif" font-size="10" font-weight="600" fill="#0277bd" text-anchor="middle">ğŸ³ Build</text>
    <text x="650" y="40" font-family="Segoe UI, Arial, sans-serif" font-size="8" fill="#37474f" text-anchor="middle">Docker Image</text>
    
    <path d="M700 27 L715 27" stroke="#c62828" stroke-width="1.5" fill="none" marker-end="url(#arrowRed)"/>
    
    <rect x="720" y="0" width="100" height="55" rx="5" fill="white" stroke="#c62828" stroke-width="1.5"/>
    <text x="770" y="22" font-family="Segoe UI, Arial, sans-serif" font-size="10" font-weight="600" fill="#c62828" text-anchor="middle">ğŸ” Trivy</text>
    <text x="770" y="40" font-family="Segoe UI, Arial, sans-serif" font-size="8" fill="#37474f" text-anchor="middle">Container Scan</text>
    
    <path d="M820 27 L835 27" stroke="#2e7d32" stroke-width="1.5" fill="none" marker-end="url(#arrowGreen)"/>
    
    <rect x="840" y="0" width="120" height="55" rx="5" fill="white" stroke="#2e7d32" stroke-width="2"/>
    <text x="900" y="22" font-family="Segoe UI, Arial, sans-serif" font-size="10" font-weight="600" fill="#2e7d32" text-anchor="middle">ğŸ“¤ Push Registry</text>
    <text x="900" y="40" font-family="Segoe UI, Arial, sans-serif" font-size="8" fill="#2e7d32" text-anchor="middle">User's Target Nexus</text>
    
    <path d="M960 27 L975 27" stroke="#7b1fa2" stroke-width="1.5" fill="none" marker-end="url(#arrowPurple)"/>
    
    <rect x="980" y="0" width="100" height="55" rx="5" fill="white" stroke="#7b1fa2" stroke-width="1.5"/>
    <text x="1030" y="22" font-family="Segoe UI, Arial, sans-serif" font-size="10" font-weight="600" fill="#7b1fa2" text-anchor="middle">ğŸš€ Deploy</text>
    <text x="1030" y="40" font-family="Segoe UI, Arial, sans-serif" font-size="8" fill="#37474f" text-anchor="middle">Environment</text>
  </g>
  
  <!-- Outcome indicators -->
  <rect x="50" y="1110" width="520" height="45" rx="6" fill="url(#successGrad)" filter="url(#shadow)"/>
  <text x="310" y="1137" font-family="Segoe UI, Arial, sans-serif" font-size="12" font-weight="bold" fill="white" text-anchor="middle">âœ… SUCCESS â†’ All stages green, quality gates passed</text>
  
  <rect x="590" y="1110" width="520" height="45" rx="6" fill="url(#failureGrad)" filter="url(#shadow)"/>
  <text x="850" y="1137" font-family="Segoe UI, Arial, sans-serif" font-size="12" font-weight="bold" fill="white" text-anchor="middle">âŒ FAILURE â†’ Stage failed, captured for auto-learning</text>
  
  <!-- Arrows to outcomes -->
  <path d="M310 1155 L310 1195" stroke="#2e7d32" stroke-width="3" fill="none" marker-end="url(#arrowGreen)"/>
  <path d="M850 1155 L850 1195" stroke="#c62828" stroke-width="3" fill="none" marker-end="url(#arrowRed)"/>

  <!-- ==================== PHASE 5: AUTOMATIC LEARNING (IMPROVED) ==================== -->
  <rect x="20" y="1190" width="1460" height="400" rx="12" fill="#ede7f6" stroke="#673ab7" stroke-width="2" filter="url(#shadow)"/>
  <text x="40" y="1220" font-family="Segoe UI, Arial, sans-serif" font-size="18" font-weight="bold" fill="#4527a0">PHASE 5: Automatic Learning Loop (Key Innovation)</text>
  
  <!-- Success Path -->
  <rect x="50" y="1245" width="500" height="320" rx="10" fill="#e8f5e9" stroke="#4caf50" stroke-width="2"/>
  <text x="300" y="1275" font-family="Segoe UI, Arial, sans-serif" font-size="16" font-weight="bold" fill="#2e7d32" text-anchor="middle">âœ… SUCCESS PATH</text>
  
  <rect x="70" y="1295" width="460" height="70" rx="6" fill="white" stroke="#66bb6a" stroke-width="1.5" filter="url(#shadow)"/>
  <text x="300" y="1318" font-family="Segoe UI, Arial, sans-serif" font-size="12" font-weight="600" fill="#2e7d32" text-anchor="middle">Pipeline Green âœ“ - Compute Success Pattern</text>
  <text x="80" y="1340" font-family="Segoe UI, Arial, sans-serif" font-size="10" fill="#37474f">â€¢ Record: repo type + generated files + scan results</text>
  <text x="80" y="1358" font-family="Segoe UI, Arial, sans-serif" font-size="10" fill="#37474f">â€¢ If human edits were made, capture "diff that mattered"</text>
  
  <path d="M300 1365 L300 1385" stroke="#2e7d32" stroke-width="2" fill="none" marker-end="url(#arrowGreen)"/>
  
  <rect x="70" y="1390" width="460" height="160" rx="6" fill="url(#aiGrad)" filter="url(#shadow)"/>
  <text x="300" y="1418" font-family="Segoe UI, Arial, sans-serif" font-size="13" font-weight="bold" fill="white" text-anchor="middle">ğŸ“š AUTO-STORE in ChromaDB</text>
  <rect x="85" y="1430" width="430" height="110" rx="4" fill="rgba(255,255,255,0.95)"/>
  <text x="300" y="1450" font-family="Segoe UI, Arial, sans-serif" font-size="10" font-weight="600" fill="#4a148c" text-anchor="middle">Stored Knowledge Vectors:</text>
  <text x="95" y="1470" font-family="Consolas, monospace" font-size="9" fill="#37474f">âœ“ Successful Dockerfile template for {lang, framework}</text>
  <text x="95" y="1487" font-family="Consolas, monospace" font-size="9" fill="#37474f">âœ“ Working .gitlab-ci.yml patterns</text>
  <text x="95" y="1504" font-family="Consolas, monospace" font-size="9" fill="#37474f">âœ“ Build/test commands that worked</text>
  <text x="95" y="1521" font-family="Consolas, monospace" font-size="9" fill="#37474f">âœ“ Registry push configurations</text>
  <text x="95" y="1535" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#7b1fa2" font-weight="600">Tags: lang=java, build=maven, registry=nexus-prod...</text>
  
  <!-- Failure Path - AUTOMATIC LEARNING HIGHLIGHTED -->
  <rect x="580" y="1245" width="880" height="320" rx="10" fill="#ffebee" stroke="#ef5350" stroke-width="2"/>
  <text x="1020" y="1275" font-family="Segoe UI, Arial, sans-serif" font-size="16" font-weight="bold" fill="#c62828" text-anchor="middle">âŒ FAILURE PATH â†’ AUTOMATIC LEARNING (No Manual Intervention)</text>
  
  <!-- Step 1: Capture -->
  <rect x="600" y="1295" width="250" height="95" rx="6" fill="white" stroke="#ef5350" stroke-width="1.5" filter="url(#shadow)"/>
  <text x="725" y="1318" font-family="Segoe UI, Arial, sans-serif" font-size="11" font-weight="600" fill="#c62828" text-anchor="middle">1ï¸âƒ£ Auto-Capture Failure</text>
  <text x="610" y="1340" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#37474f">â€¢ Failing stage &amp; job name</text>
  <text x="610" y="1355" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#37474f">â€¢ Error logs (sanitized)</text>
  <text x="610" y="1370" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#37474f">â€¢ Environment context</text>
  <text x="610" y="1385" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#37474f">â€¢ Generated files snapshot</text>
  
  <path d="M850 1342 L875 1342" stroke="#c62828" stroke-width="2" fill="none" marker-end="url(#arrowRed)"/>
  
  <!-- Step 2: LLM Analyze -->
  <rect x="880" y="1295" width="260" height="95" rx="6" fill="white" stroke="#7b1fa2" stroke-width="1.5" filter="url(#shadow)"/>
  <text x="1010" y="1318" font-family="Segoe UI, Arial, sans-serif" font-size="11" font-weight="600" fill="#7b1fa2" text-anchor="middle">2ï¸âƒ£ LLM Auto-Analyze</text>
  <text x="890" y="1340" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#37474f">â€¢ Parse error signature</text>
  <text x="890" y="1355" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#37474f">â€¢ Identify root cause category</text>
  <text x="890" y="1370" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#37474f">â€¢ Generate fix recommendation</text>
  <text x="890" y="1385" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#37474f">â€¢ Create prevention rule</text>
  
  <path d="M1140 1342 L1165 1342" stroke="#7b1fa2" stroke-width="2" fill="none" marker-end="url(#arrowPurple)"/>
  
  <!-- Step 3: Auto-Fix Proposal -->
  <rect x="1170" y="1295" width="270" height="95" rx="6" fill="url(#backendGrad)" filter="url(#shadow)"/>
  <text x="1305" y="1318" font-family="Segoe UI, Arial, sans-serif" font-size="11" font-weight="bold" fill="white" text-anchor="middle">3ï¸âƒ£ Auto-Fix &amp; Retry</text>
  <rect x="1185" y="1330" width="240" height="50" rx="4" fill="rgba(255,255,255,0.95)"/>
  <text x="1305" y="1348" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#37474f" text-anchor="middle">LLM generates patched files</text>
  <text x="1305" y="1363" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#37474f" text-anchor="middle">Backend commits fix â†’ Re-runs pipeline</text>
  <text x="1305" y="1378" font-family="Segoe UI, Arial, sans-serif" font-size="8" fill="#f57c00" text-anchor="middle">(Bounded retries: max 3 attempts)</text>
  
  <!-- Arrow down to ChromaDB storage -->
  <path d="M725 1390 L725 1420" stroke="#c62828" stroke-width="2" fill="none" marker-end="url(#arrowRed)"/>
  <path d="M1010 1390 L1010 1420" stroke="#7b1fa2" stroke-width="2" fill="none" marker-end="url(#arrowPurple)"/>
  
  <!-- AUTOMATIC ChromaDB Storage for Failures - KEY HIGHLIGHT -->
  <rect x="600" y="1405" width="840" height="145" rx="8" fill="url(#aiGrad)" filter="url(#shadow)"/>
  <rect x="610" y="1410" width="820" height="25" rx="4" fill="#ffeb3b"/>
  <text x="1020" y="1428" font-family="Segoe UI, Arial, sans-serif" font-size="12" font-weight="bold" fill="#c62828" text-anchor="middle">âš¡ AUTOMATIC STORAGE TO CHROMADB - PREVENTS SAME FAILURE AGAIN âš¡</text>
  
  <rect x="615" y="1440" width="400" height="100" rx="4" fill="rgba(255,255,255,0.95)"/>
  <text x="815" y="1460" font-family="Segoe UI, Arial, sans-serif" font-size="10" font-weight="600" fill="#4a148c" text-anchor="middle">ğŸ“ Failure Pattern Record (Auto-Created)</text>
  <text x="625" y="1480" font-family="Consolas, monospace" font-size="9" fill="#37474f">"error_signature": "npm ERR! 404 Not Found"</text>
  <text x="625" y="1495" font-family="Consolas, monospace" font-size="9" fill="#37474f">"root_cause": "private_npm_registry_config"</text>
  <text x="625" y="1510" font-family="Consolas, monospace" font-size="9" fill="#37474f">"fix_patch": "Add .npmrc with registry URL"</text>
  <text x="625" y="1525" font-family="Consolas, monospace" font-size="9" fill="#37474f">"prevention": "Always check for private deps"</text>
  
  <rect x="1025" y="1440" width="400" height="100" rx="4" fill="rgba(255,255,255,0.95)"/>
  <text x="1225" y="1460" font-family="Segoe UI, Arial, sans-serif" font-size="10" font-weight="600" fill="#4a148c" text-anchor="middle">ğŸ“ Example Fix Patterns Stored</text>
  <text x="1035" y="1480" font-family="Consolas, monospace" font-size="9" fill="#37474f">â€¢ CA cert issues â†’ Add corp CA bundle</text>
  <text x="1035" y="1495" font-family="Consolas, monospace" font-size="9" fill="#37474f">â€¢ Proxy errors â†’ Configure HTTP_PROXY vars</text>
  <text x="1035" y="1510" font-family="Consolas, monospace" font-size="9" fill="#37474f">â€¢ Permission denied â†’ Fix WORKDIR ownership</text>
  <text x="1035" y="1525" font-family="Consolas, monospace" font-size="9" fill="#37474f">â€¢ Missing runner tags â†’ Add required tags</text>

  <!-- ==================== PHASE 6: CONTINUOUS IMPROVEMENT ==================== -->
  <rect x="20" y="1610" width="1460" height="190" rx="12" fill="#e0f7fa" stroke="#00838f" stroke-width="2" filter="url(#shadow)"/>
  <text x="40" y="1640" font-family="Segoe UI, Arial, sans-serif" font-size="18" font-weight="bold" fill="#006064">PHASE 6: Continuous Improvement - Next Request Benefits</text>
  
  <!-- Flow diagram -->
  <rect x="50" y="1665" width="200" height="60" rx="6" fill="url(#userGrad)" filter="url(#shadow)"/>
  <text x="150" y="1698" font-family="Segoe UI, Arial, sans-serif" font-size="12" font-weight="bold" fill="white" text-anchor="middle">ğŸ‘¤ New Request</text>
  <text x="150" y="1715" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#e1f5fe" text-anchor="middle">"Generate CI for repo Y"</text>
  
  <path d="M250 1695 L290 1695" stroke="#00838f" stroke-width="2" fill="none" marker-end="url(#arrowCyan)"/>
  
  <rect x="300" y="1665" width="250" height="60" rx="6" fill="url(#backendGrad)" filter="url(#shadow)"/>
  <text x="425" y="1693" font-family="Segoe UI, Arial, sans-serif" font-size="11" font-weight="bold" fill="white" text-anchor="middle">ğŸ”„ Backend Queries RAG</text>
  <text x="425" y="1712" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#fff3e0" text-anchor="middle">Similar repo context + fix patterns</text>
  
  <path d="M550 1695 L590 1695" stroke="#00838f" stroke-width="2" fill="none" marker-end="url(#arrowCyan)"/>
  
  <rect x="600" y="1665" width="280" height="60" rx="6" fill="url(#aiGrad)" filter="url(#shadow)"/>
  <text x="740" y="1688" font-family="Segoe UI, Arial, sans-serif" font-size="11" font-weight="bold" fill="white" text-anchor="middle">ğŸ“š ChromaDB Returns</text>
  <text x="740" y="1705" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#e1bee7" text-anchor="middle">â€¢ Past success templates</text>
  <text x="740" y="1720" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#e1bee7" text-anchor="middle">â€¢ Known fix patterns to avoid failures</text>
  
  <path d="M880 1695 L920 1695" stroke="#00838f" stroke-width="2" fill="none" marker-end="url(#arrowCyan)"/>
  
  <rect x="930" y="1665" width="280" height="60" rx="6" fill="url(#successGrad)" filter="url(#shadow)"/>
  <text x="1070" y="1693" font-family="Segoe UI, Arial, sans-serif" font-size="11" font-weight="bold" fill="white" text-anchor="middle">âœ… Better Generation</text>
  <text x="1070" y="1712" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#e8f5e9" text-anchor="middle">Fewer failures, faster time-to-green</text>
  
  <path d="M1210 1695 L1250 1695" stroke="#00838f" stroke-width="2" fill="none" marker-end="url(#arrowCyan)"/>
  
  <rect x="1260" y="1665" width="200" height="60" rx="6" fill="#00838f" filter="url(#shadow)"/>
  <text x="1360" y="1693" font-family="Segoe UI, Arial, sans-serif" font-size="11" font-weight="bold" fill="white" text-anchor="middle">ğŸ¯ Pipeline Success</text>
  <text x="1360" y="1712" font-family="Segoe UI, Arial, sans-serif" font-size="9" fill="#b2ebf2" text-anchor="middle">First-time pass rate â†‘</text>
  
  <!-- Key improvements summary -->
  <rect x="50" y="1740" width="1410" height="45" rx="6" fill="white" stroke="#00838f" stroke-width="1.5"/>
  <text x="750" y="1768" font-family="Segoe UI, Arial, sans-serif" font-size="12" font-weight="600" fill="#006064" text-anchor="middle">ğŸ”„ Self-Improving System: Each failure automatically teaches the system â†’ Future generations incorporate learned patterns â†’ Continuous quality improvement</text>

  <!-- ==================== LEGEND ==================== -->
  <rect x="20" y="1820" width="1460" height="260" rx="12" fill="white" stroke="#e0e0e0" stroke-width="1"/>
  <text x="40" y="1850" font-family="Segoe UI, Arial, sans-serif" font-size="16" font-weight="bold" fill="#424242">Legend &amp; Key Architecture Components</text>
  
  <g transform="translate(40, 1870)">
    <rect x="0" y="0" width="20" height="20" rx="4" fill="url(#userGrad)"/>
    <text x="30" y="15" font-family="Segoe UI, Arial, sans-serif" font-size="11" fill="#37474f">User/Admin</text>
    
    <rect x="130" y="0" width="20" height="20" rx="4" fill="url(#frontendGrad)"/>
    <text x="160" y="15" font-family="Segoe UI, Arial, sans-serif" font-size="11" fill="#37474f">Open WebUI</text>
    
    <rect x="270" y="0" width="20" height="20" rx="4" fill="url(#backendGrad)"/>
    <text x="300" y="15" font-family="Segoe UI, Arial, sans-serif" font-size="11" fill="#37474f">Backend Orchestrator</text>
    
    <rect x="450" y="0" width="20" height="20" rx="4" fill="url(#aiGrad)"/>
    <text x="480" y="15" font-family="Segoe UI, Arial, sans-serif" font-size="11" fill="#37474f">AI/RAG Stack</text>
    
    <rect x="590" y="0" width="20" height="20" rx="4" fill="url(#gitlabGrad)"/>
    <text x="620" y="15" font-family="Segoe UI, Arial, sans-serif" font-size="11" fill="#37474f">GitLab</text>
    
    <rect x="700" y="0" width="20" height="20" rx="4" fill="url(#securityGrad)"/>
    <text x="730" y="15" font-family="Segoe UI, Arial, sans-serif" font-size="11" fill="#37474f">Security Scans</text>
    
    <rect x="850" y="0" width="20" height="20" rx="4" fill="url(#configGrad)"/>
    <text x="880" y="15" font-family="Segoe UI, Arial, sans-serif" font-size="11" fill="#37474f">Config Storage (PostgreSQL)</text>
    
    <rect x="1050" y="0" width="20" height="20" rx="4" fill="url(#storageGrad)"/>
    <text x="1080" y="15" font-family="Segoe UI, Arial, sans-serif" font-size="11" fill="#37474f">Knowledge Storage (ChromaDB)</text>
  </g>
  
  <!-- Key Points -->
  <g transform="translate(40, 1910)">
    <text x="0" y="15" font-family="Segoe UI, Arial, sans-serif" font-size="12" font-weight="600" fill="#1565c0">ğŸ” AUTO-DETECTION:</text>
    <text x="130" y="15" font-family="Segoe UI, Arial, sans-serif" font-size="11" fill="#37474f">Language, build tool, framework detected automatically from repo - User only provides: Repo URL + Target Registry</text>
    
    <text x="0" y="40" font-family="Segoe UI, Arial, sans-serif" font-size="12" font-weight="600" fill="#2e7d32">ğŸ’¾ CONFIG STORAGE:</text>
    <text x="130" y="40" font-family="Segoe UI, Arial, sans-serif" font-size="11" fill="#37474f">Prompts, model configs, tools settings stored in PostgreSQL (ai-postgres:5432) - UI configs persist across sessions</text>
    
    <text x="0" y="65" font-family="Segoe UI, Arial, sans-serif" font-size="12" font-weight="600" fill="#7b1fa2">ğŸ“š RAG KNOWLEDGE:</text>
    <text x="130" y="65" font-family="Segoe UI, Arial, sans-serif" font-size="11" fill="#37474f">Templates, fix patterns, best practices stored in ChromaDB (:8000) - Vectors indexed for semantic retrieval</text>
    
    <text x="0" y="90" font-family="Segoe UI, Arial, sans-serif" font-size="12" font-weight="600" fill="#c62828">âš¡ AUTO-LEARNING:</text>
    <text x="130" y="90" font-family="Segoe UI, Arial, sans-serif" font-size="11" fill="#37474f">Pipeline failures automatically analyzed by LLM â†’ Fix patterns stored in ChromaDB â†’ Same failure prevented in future</text>
  </g>
  
  <!-- Data Flow Summary -->
  <rect x="40" y="2010" width="1420" height="55" rx="6" fill="#e3f2fd" stroke="#1976d2" stroke-width="1"/>
  <text x="750" y="2035" font-family="Segoe UI, Arial, sans-serif" font-size="11" font-weight="600" fill="#1565c0" text-anchor="middle">Complete Data Flow:</text>
  <text x="750" y="2055" font-family="Segoe UI, Arial, sans-serif" font-size="10" fill="#37474f" text-anchor="middle">User (repo URL + registry) â†’ Open WebUI (load prompts/tools from PostgreSQL) â†’ Backend â†’ GitLab (auto-detect) â†’ RAG Query (ChromaDB) â†’ LLM Generate â†’ Validate â†’ Commit â†’ Pipeline â†’ Success/Failure â†’ Auto-Learn â†’ ChromaDB</text>

</svg>